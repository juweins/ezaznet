name: Terraform Module CI

on:
  push:
    branches:
      - master

jobs:
  terraform-modules:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout repository
      uses: actions/checkout@v2

    - name: Set up Terraform
      uses: hashicorp/setup-terraform@v1
      with:
        cli_config_credentials_token: ${{ secrets.TF_API_TOKEN }}

    - name: Find Terraform modules
      id: find_modules
      run: |
            # Find all directories under the "terraform" folder in the repository
            find ./terraform/* -type d > modules.txt
            echo "::set-output name=modules::$(cat modules.txt)"

          
    - name: Iterate through Terraform modules
      run: |
            # Read the output variable from the previous step
            file="modules.txt"

            # While loop to iterate through entire terraform directory
            while IFS= read -r line
            do
                module_name=$(basename $line)

                echo "-----------------------------------"

                echo "Processing module $module_name"
                cd $line

                echo "Initializing Terraform..."
                terraform init

                echo "Validating Terraform..."
                terraform validate

                echo "Formatting Terraform..."
                terraform fmt -check

                echo "Success! $module_name is OK."
                echo "-----------------------------------"
                cd ../..
            done <"$file"
    
    - name: Run tflint
      uses: devops-infra/action-tflint@v0.3
      with:
        dir_filter: terraform/*/
            